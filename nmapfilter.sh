#!/bin/bash

if [[ $# == 0 || $1 == "-h" ]]
then
  echo "Usage: $0 [-f FIELD] [-p PORT] [-s STATE] [-t SERVICE] FILE...
Filter Nmap output in FILE... based on some parameters.

  -f FIELD    field numbers, separated by commas and dashes, default to \"1-\"
  -p PORT     port, in regex, default to \"[0-9]+\"
  -s STATE    state, default to \".*\"
  -t SERVICE  service type, default to \".*\"
  FILE...     input files
"
  exit 1
fi

FIELDS=1-
PORT="[0-9]+"
STATE="[^ ]*"
SERVICE="[^ ]*"

while [[ $# > 0 ]]
do
  key="$1"
  value="$2"
  case $key in
  -f)
    FIELDS="$value"
    shift
    ;;
  -p)
    PORT="$value"
    shift
    ;;
  -s)
    STATE="$value"
    shift
    ;;
  -t)
    SERVICE="$value"
    shift
    ;;
  *)
    INFILES[${#INFILES[@]}]="$key"
    ;;
  esac
  shift
done

cat "${INFILES[@]}" | awk '
/^Nmap scan report for/ {
  if (!$6) IP = $5; else IP = substr($6,2,length($6)-2)
}
/^'"$PORT"'\/(tcp|udp) +'"$STATE"' +'"$SERVICE"'/ {
  sub("/", " ")
  print IP "\t" $1 "\t" $2 "\t" $3 "\t" $4
}
' | cut -f "$FIELDS" | sort --unique


#fikr4n 2015
