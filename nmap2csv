#!/usr/bin/python3
"""Convert Nmap output to CSV, in case you forgot to use option -o of Nmap."""
"""
Author:
    Fikrul
"""
import sys
import csv
import argparse
import re

header_p = re.compile(r'Nmap scan report for (?P<host>\S+)( \((?P<ip>\S+)\))?')
scan_p = re.compile(r'(\S+)/(tcp|udp) +(\S+) +(\S+) *(.*)\n')


def process_file(result, f):
  ip, hostname = None, None

  prev = None
  for line in f:
    scan_m = scan_p.match(line)
    if scan_m:
      result.append([ip, hostname] + list(scan_m.groups()) + [''])
      prev = 'port'
      continue

    header_m = header_p.match(line)
    if header_m:
      ip = header_m.group('ip')
      host = header_m.group('host')
      if ip is None: ip, hostname = host, None
      else: hostname = host
      prev = 'host'
      continue

    if line.startswith('|'): # more notes on previous line
      if prev is not None:
        result[-1][-1] += line
    elif line.startswith('Running: '):
      result.append([ip, hostname, '0', '', '', 'OS', line[9:-1], ''])
      prev = 'os'
    elif line.startswith('Running (JUST GUESSING): '):
      result.append([ip, hostname, '0', '', '', 'OS (guess)', line[25:-1], ''])
      prev = 'os-guess'
    elif line.startswith('Aggressive OS guesses: '):
      if prev == 'os-guess':
        result[-1][-1] += line[23:-1]
      else:
        result.append([ip, hostname, '0', '', '', 'OS (guess)', '',
          line[23:-1]])
        prev = 'os-guess'
    elif line.startswith('OS CPE: '):
      if prev != 'os-guess':
        prev = None
    else:
      prev = None


def main():
  parser = argparse.ArgumentParser(description=__doc__)
  parser.add_argument('filenames', metavar='FILE', nargs='+',
    help='input filename (Nmap output)')
  parser.add_argument('-S', '--no-supplemental', action='store_true',
    help='exclude supplemental information i.e. lines after each port information start with pipe ("|")')
  args = parser.parse_args()

  rows = [['IP', 'Hostname', 'Port', 'TP', 'State', 'Service', 'Description',
    'Supplemental Info']]
  for filename in args.filenames:
    with open(filename) as f:
      process_file(rows, f)

  writer = csv.writer(sys.stdout)
  print_all = not args.no_supplemental
  for row in rows:
    if print_all:
      writer.writerow(row)
    else:
      writer.writerow(row[:-1])


if __name__ == '__main__':
  main()

# fikr4n 2015
